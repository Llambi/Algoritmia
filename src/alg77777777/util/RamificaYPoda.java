// ESQUEMA GENERAL RAMIFICA Y PODA

package alg77777777.util;

import java.util.ArrayList;
import java.util.Comparator;

/**
 * Clase principal genérica que implementa la técnica de Ramificación y poda
 */
public class RamificaYPoda {
    public static boolean TRAZA = true;    // Activa / desactiva traza por pantalla

    protected ColaPrioridad cola;    // nodos pendientes de expandir
    protected Estado nodoRaiz;        // contiene el nodo inicial

    public static int COTAPODA;            // valor de la cota de poda

    protected Estado mejorSolucion;    // para guardar el nodo de la mejor solución (aplicable a probl. optimización

    public RamificaYPoda() {
        cola = new ColaPrioridad(Comparator.comparingInt(Estado::getHeuristico));        //crea Monticulo vacío
    }

    /**
     * Método principal que implementa la ejecución de la técnica Ramifica y poda
     *
     * @param nodoRaiz Le pasamos el nodo raíz para el problema que queremos resolver
     */
    public void ramificaYPoda(Estado nodoRaiz) {
        cola.insertar(nodoRaiz);

        COTAPODA = nodoRaiz.valorInicialPoda();        // Inicializa cota a un valor inicial, por defecto +infinito (no poda)

        // Procesamos los estados de la cola
        // mientras la cola no esté vacía y el mejor estado no esté por enciam de la cota de poda
        while (!cola.vacia() && cola.estimacionMejor() < COTAPODA) {
            Estado actual = cola.sacarMejorNodo();        // recuperamos el estado más prometedor

            ArrayList<Estado> hijos = actual.expandir();    // expandimos todos los hijos válidos del estado acutal

            // Recorre todos los hijos creados comprobando que están por debajo de la cota de poda
            for (Estado estadoHijo : hijos) {
                if (estadoHijo.getHeuristico() < COTAPODA) {  // ¿Está por debajo de la cota?
                    if (estadoHijo.solucion())                // ¿Es una solución al problema?
                    {
                        // si es solución y no la hemos podado, seguro que es mejor que la anterior
                        mejorSolucion = estadoHijo;
                        COTAPODA = estadoHijo.getHeuristico();    // Establecemos la cota al valor de la nueva solución

                        /**/
                        if (TRAZA) {
                            System.out.println("*** Nueva solución mejor");
                            System.out.println("Nueva cota de poda: " + COTAPODA);
                            System.out.println(estadoHijo + "\n");
                        }
                    } else {
                        // si no es solución a la cola de prioridad, pendiente de desarrollar
                        cola.insertar(estadoHijo);
                    }
                }
            }
        } //while
    }


    public Estado getNodoRaiz() {
        return nodoRaiz;
    }


    public void mostrarTrazaSolucion() {
        System.out.println("**************************************************************");
        System.out.println("Solucion al problema");
        if (mejorSolucion == null) {
            System.out.println("NO HAY SOLUCION");
        } else {

            System.out.println("\nMejor asignacion: " + mejorSolucion);
            System.out.println("\nMejor puntuacion: " + mejorSolucion.getHeuristico());
            System.out.println("\nSolución de " + mejorSolucion.getProfundidad() + " pasos\n");
        }
    }
}
